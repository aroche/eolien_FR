(function(){function B(a){if(a instanceof Array)a=a.map(B);else if(!("string"===typeof a||"number"===typeof a)){var l={},m;for(m in a)l[m]=B(a[m]);a=l}return a}d3.cartogram=function(){function a(a,f){a=B(a);for(var q=L(a.transform),x,p,e,c,s,A=a.arcs.length,d=0,k=Array(A);d<A;){p=x=0;e=a.arcs[d].length;c=0;for(s=Array(e);c<e;)a.arcs[d][c][0]=x+=a.arcs[d][c][0],a.arcs[d][c][1]=p+=a.arcs[d][c][1],s[c]=m(q(a.arcs[d][c])),c++;k[d++]=s}var E=d3.geo.path().projection(null);e={type:"GeometryCollection", geometries:f};var F=function(a){for(var c=[],d=0,h=a.length;d<h;++d){var b=a[d],f=c;f.length&&f.pop();for(var e=k[0>b?~b:b],j=0,g=e.length;j<g;++j)f.push(e[j]);if(0>b){b=f;f=void 0;e=b.length;for(g=e-g;g<--e;)f=b[g],b[g++]=b[e],b[e]=f}}return c},C=function(a){return a.map(F)};c=function(a){a=Object.create(a);a.coordinates=M[a.type](a.arcs);return a};var M={LineString:F,MultiLineString:C,Polygon:C,MultiPolygon:function(a){return a.map(C)}},q=("GeometryCollection"===e.type?(e=Object.create(e),e.geometries= e.geometries.map(c),e):c(e)).geometries.map(function(b){return{type:"Feature",id:b.id,properties:r.call(null,b,a),geometry:b}}),G=q.map(t),N=d3.sum(G);if(0>=l)return q;for(x=0;x++<l;){var H=q.map(E.area),O=d3.sum(H),D=0,I=0;p=q.map(function(a,b){var c=Math.abs(H[b]),f=+G[b],d=O*f/N,e=Math.sqrt(c/Math.PI),g=Math.sqrt(d/Math.PI)-e,h=Math.max(c,d)/Math.min(c,d);D+=h;I++;return{id:a.id,area:c,centroid:E.centroid(a),value:f,desired:d,radius:e,mass:g,sizeError:h}});s=D/I;for(var J=1/(1+s),y,A=k.length, d=0,K,u,b,v,j,w,n,z,g;d<A;){e=k[d].length;for(c=0;c<e;){y=[0,0];K=p.length;for(u=0;u<K;)b=p[u].centroid,v=p[u].mass,j=p[u].radius,w=j*j,n=k[d][c][0]-b[0],b=k[d][c][1]-b[1],z=n*n+b*b,g=Math.sqrt(z),v=g>j?v*j/g:v*(z/w)*(4-3*g/j),j=y,w=j[0],z=v,g=b/n,g=0<n?1/Math.sqrt(1+g*g):-1/Math.sqrt(1+g*g),j[0]=w+z*g,j=y,w=j[1],b/=n,n=0<n?b/Math.sqrt(1+b*b):-b/Math.sqrt(1+b*b),j[1]=w+v*n,u++;k[d][c][0]+=y[0]*J;k[d][c][1]+=y[1]*J;c++}d++}if(1>=s)break}return{features:q,arcs:k}}var l=8,m=d3.geo.albers(),r=function(){return{}}, t=function(){return 1};a.path=d3.geo.path().projection(null);a.iterations=function(h){return arguments.length?(l=h,a):l};a.value=function(h){return arguments.length?(t=d3.functor(h),a):t};a.projection=function(h){return arguments.length?(m=h,a):m};a.feature=function(a,f){return{type:"Feature",id:f.id,properties:r.call(null,f,a),geometry:{type:f.type,coordinates:topojson.object(a,f).coordinates}}};a.features=function(h,f){return f.map(function(f){return a.feature(h,f)})};a.properties=function(h){return arguments.length? (r=d3.functor(h),a):r};return a};var L=d3.cartogram.transformer=function(a){function l(a){return[a[0]*m+t,a[1]*r+h]}var m=a.scale[0],r=a.scale[1],t=a.translate[0],h=a.translate[1];l.invert=function(a){return[(a[0]-t)/m,(a[1]-h)/r]};return l}})(this);